---
title: "Exploration of juvenile outmigration"
format: html
editor: visual
---

**Goal** Understand timing and patterns of juvenile outmigration on the Feather River and compare to timing and density of fish observations in the mini snorkel dataset.

**Insights**

-   The majority of catch in RSTs on the Feather River (both LFC and HFC) have passed through by March (\~80%)
-   There are small differences in cumulative catch curves between the HFC and LFC indicating that outmigration is not affecting these sites differently
-   The fish that remain in the Feather River after March and into May and June are likely larger ( \> 50mm) which aligns with the fork length distributions by month in the habitat data

```{r}
library(tidyverse)
library(plotly)
library(EDIutils)
colors_small <-  c("#9A8822", "#F5CDB4", "#F8AFA8", "#FDDDA0", "#74A089", #Royal 2
                   "#899DA4", "#C93312", "#DC863B" # royal 1 (- 3)
)
# Use data from SRJPEdata for the Feather River
feather_rst <- SRJPEdata::rst_catch |> filter(stream == "feather river")
feather_rst_daily <- feather_rst |> 
  group_by(date, stream, site, site_group) |> 
  summarize(count = sum(count))

res <- read_data_entity_names(packageId = "edi.1705.2")
raw <- read_data_entity(packageId = "edi.1705.2", entityId = res$entityId[1])
locations_raw <- read_csv(file = raw)
raw <- read_data_entity(packageId = "edi.1705.2", entityId = res$entityId[2])
fish_raw <- read_csv(file = raw)

mini_snorkel_raw <- fish_raw |> left_join(locations_raw |> distinct()) |> 
  mutate(count = ifelse(is.na(count), 0, count),
        fish_presence = as.factor(ifelse(count < 1, "0", "1")),
        month = month(date)) |> 
  glimpse()
```

```{r}
# EDCF - Pascale requested these plots
ggplot(feather_rst_daily, aes(x = count, color = site)) + 
  stat_ecdf(geom = "step") +
  labs(title = "ECDF Plot", y = "Proportion", x = "Value") +
  facet_wrap(~site_group)
```

```{r}
cumulative <- feather_rst_daily |> 
  mutate(water_year = ifelse(month(date) %in% 10:12, year(date) + 1, year(date)),
         fake_date = as_date(paste(ifelse(month(date) %in% 10:12, 1999, 2000), month(date), day(date)))) |> 
  arrange(date) %>%
  group_by(site, water_year) %>%
  mutate(count = ifelse(is.na(count), 0, count), 
         total_count = sum(count, na.rm = T), 
         cumulative_catch = cumsum(count),
         prop_cuml_catch = cumulative_catch/total_count * 100)

plot_ly(
  cumulative,
  x = ~ fake_date,
  y = ~ prop_cuml_catch,
  color = ~ site,
  text = ~ water_year,
  hovertemplate = paste("Water Year: %{text}"),
  colors = colors_small,
  type = 'scatter',
  mode = 'lines'
) %>%
  layout(
    title = "Cumulative Catch in RST",
    xaxis = list(title = "Months", tickformat = "%b"),
    yaxis = list(title = "Percent Cumulative Catch")
  ) 
```

```{r}
plot_ly(
  filter(cumulative, water_year %in% 2001:2002),
  x = ~ fake_date,
  y = ~ prop_cuml_catch,
  color = ~ site,
  text = ~ water_year,
  hovertemplate = paste("Water Year: %{text}"),
  colors = colors_small,
  type = 'scatter',
  mode = 'lines'
) %>%
  layout(
    title = "Cumulative Catch in RST",
    xaxis = list(title = "Months", tickformat = "%b"),
    yaxis = list(title = "Percent Cumulative Catch")
  ) 
```

```{r}
feather_fl <- feather_rst |> 
  group_by(date, stream, site, site_group, fork_length) |> 
  summarize(count = sum(count)) |> 
  mutate(water_year = ifelse(month(date) %in% 10:12, year(date) + 1, year(date))) |> 
  filter(water_year %in% 2001:2002) 

feather_fl |> 
  ggplot(aes(x = fork_length, fill = site)) +
  geom_density()
```

```{r}
mini_snorkel_raw |> 
  filter(fl_mm < 100) |> 
  ggplot(aes(x = fl_mm, fill = as.factor(month))) +
  geom_density(alpha = 0.5)
```

```{r}
cumulative_fl  <- feather_fl |> 
  mutate(water_year = ifelse(month(date) %in% 10:12, year(date) + 1, year(date)),
         fake_date = as_date(paste(ifelse(month(date) %in% 10:12, 1999, 2000), month(date), day(date))),
         fl_dummy = ifelse(fork_length < 50, "small", "large")) |> 
  arrange(date) %>%
  group_by(site, fl_dummy, water_year) %>%
  mutate(count = ifelse(is.na(count), 0, count), 
         total_count = sum(count, na.rm = T), 
         cumulative_catch = cumsum(count),
         prop_cuml_catch = cumulative_catch/total_count * 100)
plot_ly(
  filter(cumulative_fl, water_year %in% 2001:2002, fl_dummy == "small"),
  x = ~ fake_date,
  y = ~ prop_cuml_catch,
  color = ~ site,
  text = ~ water_year,
  hovertemplate = paste("Water Year: %{text}"),
  colors = colors_small,
  type = 'scatter',
  mode = 'lines'
) %>%
  layout(
    title = "Cumulative Catch in RST",
    xaxis = list(title = "Months", tickformat = "%b"),
    yaxis = list(title = "Percent Cumulative Catch")
  ) 

plot_ly(
  filter(cumulative_fl, water_year %in% 2001:2002, fl_dummy == "large"),
  x = ~ fake_date,
  y = ~ prop_cuml_catch,
  color = ~ site,
  text = ~ water_year,
  hovertemplate = paste("Water Year: %{text}"),
  colors = colors_small,
  type = 'scatter',
  mode = 'lines'
) %>%
  layout(
    title = "Cumulative Catch in RST",
    xaxis = list(title = "Months", tickformat = "%b"),
    yaxis = list(title = "Percent Cumulative Catch")
  ) 
```
