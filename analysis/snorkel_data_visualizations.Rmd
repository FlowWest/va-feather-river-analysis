---
title: "Snorkel Data Visualizations"
author: "Ashley Vizek (FlowWest)"
date: "`r Sys.Date()`"
output: 
  html_document
---

Draft visualizations to communicate the Feather River snorkel data, specifically
as it is related to the Science Plan/Strategic Plan. 

It is difficult to tease apart correlations with fish observations and cover
when looking at each of the cover variables independently. When considering both
inchannel and overhead cover (and all types of each) together, then it becomes
apparent that more fish observations are made in areas with cover.

Analysis framing

- presence/absence
- absolute number of fish
- summarized by transect, summarized by location
- individual cover types
- cover or no cover

# TODO

- Add bar chart that has bar for absence/presence by cover type


```{r, include = F}
library(tidyverse)
library(ggalluvial)
source(here::here("data-raw","pull_from_edi.R"))
mini_snorkel_model_ready <- mini_fish_raw |> 
  left_join(mini_locations_raw |> 
              distinct(location_table_id, date, channel_location)) |> 
  mutate(count = ifelse(is.na(count), 0, count),
        fish_presence = as.factor(ifelse(count < 1, "0", "1")),
         woody_debris = ifelse(percent_small_woody_cover_inchannel >= 20 | percent_large_woody_cover_inchannel >= 20, 1, 0),
         boulder = ifelse(percent_boulder_substrate >= 20, 1, 0),
         cobble = ifelse(percent_cobble_substrate >= 20, 1, 0),
         undercut_bank = ifelse(percent_undercut_bank >= 20, 1, 0),
         aquatic_veg = ifelse(percent_submerged_aquatic_veg_inchannel >= 20, 1, 0),
         overhanging_veg = ifelse(percent_no_cover_overhead <= 80, 1, 0))

colors_small <-  c("#9A8822", "#F5CDB4", "#F8AFA8", "#FDDDA0", "#74A089", #Royal 2
                   "#899DA4", "#C93312", "#DC863B" # royal 1 (- 3)
)
colors_full <-  c("#9A8822", "#F5CDB4", "#F8AFA8", "#FDDDA0", "#74A089", #Royal 2
                  "#899DA4", "#C93312", "#DC863B", # royal 1 (- 3)
                  "#F1BB7B", "#FD6467", "#5B1A18", "#D67236",# Grand Budapest 1 (-4)
                  "#D8B70A", "#02401B", "#A2A475", # Cavalcanti 1
                  "#E6A0C4", "#C6CDF7", "#D8A499", "#7294D4", #Grand Budapest 2
                  "#9986A5", "#EAD3BF", "#AA9486", "#B6854D", "#798E87", # Isle of dogs 2 altered slightly
                  "#F3DF6C", "#CEAB07", "#D5D5D3", "#24281A", # Moonriese 1, 
                  "#798E87", "#C27D38", "#CCC591", "#29211F", # moonrise 2
                  "#85D4E3", "#F4B5BD", "#9C964A", "#CDC08C", "#FAD77B" # moonrise 3 
)
```

# Presence/absence comparisons

not helpful plot

Percent cover by percent of observations where fish was present

```{r}
total_fish_obs <- mini_snorkel_model_ready |> 
  filter(fish_presence == "1") |> 
  tally()
mini_snorkel_model_ready |> 
  mutate(month = month(date)) |> 
  pivot_longer(cols = c(percent_cobble_substrate, percent_boulder_substrate, percent_small_woody_cover_inchannel, percent_large_woody_cover_inchannel, percent_submerged_aquatic_veg_inchannel, percent_undercut_bank, percent_cover_half_meter_overhead, percent_cover_more_than_half_meter_overhead), names_to = "cover", values_to = "cover_percent") |> 
  filter(fish_presence == "1") |> 
  group_by(cover, cover_percent) |> 
  tally() |> 
  mutate(percent = (n/1235)*100) |> 
  ggplot(aes(x = percent, y = cover_percent)) +
  geom_line() +
  facet_wrap(~cover)   
```
Frequency of fish observations for each cover type and at each cover percentage level. Observations are colored based on whether other cover exists to communicate that often when fish were observed at 0% cover level for a particular cover, a different cover type existed (at 20% or greater).

```{r}
mini_snorkel_model_ready |> 
  mutate(other_cover = ifelse(woody_debris == 0 & boulder == 0 & undercut_bank == 0 & aquatic_veg == 0 & overhanging_veg == 0, "no other cover", "other cover"),
         other_cover = ifelse(is.na(other_cover), "no other cover", other_cover)) |> 
  pivot_longer(cols = c(percent_cobble_substrate, percent_boulder_substrate, percent_small_woody_cover_inchannel, percent_large_woody_cover_inchannel, percent_submerged_aquatic_veg_inchannel, percent_undercut_bank, percent_cover_half_meter_overhead, percent_cover_more_than_half_meter_overhead), names_to = "cover", values_to = "cover_percent") |> 
  filter(fish_presence == "1") |> 
  group_by(cover, cover_percent, other_cover) |> 
  summarize(count = sum(count)) |> 
  ggplot(aes(y = count, x = cover_percent, fill = other_cover)) +
  geom_col() +
  facet_wrap(~cover) +
  theme_bw() +
  theme(legend.position = "bottom") +
  scale_fill_manual(values = colors_small) +
  labs(y = "number of fish observed",
       x = "cover percentage",
       fill = "")
```
This plot synthesizes this one step further by summarizing cover percentage based on below 20% or greater than/equal to.

```{r}
mini_snorkel_model_ready |> 
  mutate(other_cover = ifelse(woody_debris == 0 & boulder == 0 & undercut_bank == 0 & aquatic_veg == 0 & overhanging_veg == 0, "no other cover", "other cover"),
         other_cover = ifelse(is.na(other_cover), "no other cover", other_cover)) |> 
  pivot_longer(cols = c(percent_cobble_substrate, percent_boulder_substrate, percent_small_woody_cover_inchannel, percent_large_woody_cover_inchannel, percent_submerged_aquatic_veg_inchannel, percent_undercut_bank, percent_cover_half_meter_overhead, percent_cover_more_than_half_meter_overhead), names_to = "cover", values_to = "cover_percent") |> 
  filter(fish_presence == "1") |> 
  mutate(cover_percent = ifelse(cover_percent >= 20, ">= 20% +", "< 20%")) |> 
  group_by(cover, cover_percent, other_cover) |> 
  summarize(count = sum(count)) |> 
  ggplot(aes(y = count, x = cover_percent, fill = other_cover)) +
  geom_col() +
  facet_wrap(~cover) +
  theme_bw() +
  theme(legend.position = "bottom") +
  scale_fill_manual(values = colors_small) +
  labs(y = "number of fish observed",
       x = "cover percentage",
       fill = "")
```




```{r}
mini_snorkel_model_ready |> 
  filter(percent_boulder_substrate == 0) |> 
  mutate(other_cover = ifelse(woody_debris == 1 | cobble == 1 | undercut_bank == 1 | aquatic_veg == 1 | overhanging_veg == 1, 1, 0)) |> 
  group_by(other_cover) |> 
  tally() |> 
  ggplot(aes(x = other_cover, y = n)) +
  geom_col()
  
  
  pivot_longer(cols = c(percent_cobble_substrate, percent_boulder_substrate, percent_small_woody_cover_inchannel, percent_large_woody_cover_inchannel, percent_submerged_aquatic_veg_inchannel, percent_undercut_bank, percent_cover_half_meter_overhead, percent_cover_more_than_half_meter_overhead), names_to = "cover", values_to = "cover_percent") |> 
  filter(fish_presence == "1") |> 
  group_by(cover, cover_percent) |> 
  tally() |> 
  ggplot(aes(y = n, x = cover_percent)) +
  geom_col() +
  facet_wrap(~cover)   
```

```{r}
microhabitat <- mini_snorkel_model_ready |> 
  mutate(no_cover = ifelse(woody_debris == 0 & boulder == 0 & undercut_bank == 0 & aquatic_veg == 0 & overhanging_veg == 0, 1, 0)) |> 
  pivot_longer(cols = c(no_cover, woody_debris, boulder, cobble, undercut_bank, aquatic_veg, overhanging_veg), names_to = "cover_type", values_to = "cover_exists") |> 
  select(micro_hab_data_tbl_id, cover_type, cover_exists, fish_presence) |> 
  distinct() |> 
  filter(cover_exists == 1)
total_by_cover <- microhabitat |> 
  group_by(cover_type) |> 
  tally() |> 
  rename(n_total = n)
total_habitat <- total_by_cover |> 
  summarize(n_total = sum(n_total))
  
total_by_cover |> 
  mutate(percent = (n_total/total_habitat$n_total)*100) |> 
  ggplot(aes(x = cover_type, y = percent)) +
  geom_col() 
```


The percent of fish observations where a particular cover type also occurred (defined as 20% or greater)
- Add no cover

```{r}
mini_snorkel_model_ready |> 
  pivot_longer(cols = c(woody_debris, boulder, cobble, undercut_bank, aquatic_veg, overhanging_veg), names_to = "cover_type", values_to = "cover_exists") |> 
  filter(cover_exists == 1, fish_presence == "1") |> 
  group_by(cover_type) |> 
  tally() |> 
  mutate(percent = (n/1235)*100) |> 
  ggplot(aes(x = cover_type, y = percent)) +
  geom_col() 
```
The percentage of times where the cover type was observed with fish out of total times cover was observed
- This isn't a great visualization because we are more interested in the number of times the fish was observed where was it

```{r}
microhabitat <- mini_snorkel_model_ready |> 
  pivot_longer(cols = c(woody_debris, boulder, cobble, undercut_bank, aquatic_veg, overhanging_veg), names_to = "cover_type", values_to = "cover_exists") |> 
  select(micro_hab_data_tbl_id, cover_type, cover_exists, fish_presence) |> 
  distinct() |> 
  filter(cover_exists == 1)
total_by_cover <- microhabitat |> 
  group_by(cover_type) |> 
  tally() |> 
  rename(n_total = n)
  
microhabitat |> 
  group_by(cover_type, fish_presence) |> 
  tally() |> 
  left_join(total_by_cover) |> 
  mutate(percent = (n/n_total)*100) |> 
  ggplot(aes(x = cover_type, y = percent, fill = fish_presence)) +
  geom_col() 
```

Fish are not observed at both high and low cover percentages.

```{r}
mini_snorkel_model_ready |> 

  pivot_longer(cols = c(percent_cobble_substrate, percent_boulder_substrate, percent_small_woody_cover_inchannel, percent_large_woody_cover_inchannel, percent_submerged_aquatic_veg_inchannel, percent_undercut_bank, percent_cover_half_meter_overhead, percent_cover_more_than_half_meter_overhead), names_to = "cover", values_to = "cover_percent") |> 
  filter(fish_presence == "1") |> 
  group_by(cover, cover_percent) |> 
  tally() |> 
  mutate(percent = (n/1235)*100) |> 
  ggplot(aes(x = percent, y = cover_percent)) +
  geom_point() +
  facet_wrap(~cover)   
```

```{r}
mini_snorkel_model_ready |> 
  mutate(inchannel_cover_dummy = factor(ifelse(percent_no_cover_inchannel <= 80 | percent_no_cover_overhead <= 80, 1, 0))) |> 
  filter(fish_presence == "1") |> 
  group_by(inchannel_cover_dummy) |> 
  tally() |> 
  mutate(percent = (n/1235)*100) |> 
  mutate(category = ifelse(inchannel_cover_dummy == 0, "no cover", "cover")) |> 
  ggplot(aes(x = category, y = percent)) +
  geom_col() +
  theme_bw() +
  labs(x = "",
       y = "percent of fish observations")
```

Alluvial plot to look at combinations of cover

```{r}
cover_by_type <- mini_snorkel_model_ready |> 
  select(count, woody_debris, boulder, cobble, undercut_bank, aquatic_veg, overhanging_veg) |> 
  mutate(cover_1 = case_when(woody_debris > 0 ~ "woody debris",
                             woody_debris == 0 & boulder > 0 ~ "boulder",
                             woody_debris == 0 & boulder == 0 & cobble > 0 ~ "cobble",
                             woody_debris == 0 & boulder == 0 & cobble == 0 & undercut_bank > 0 ~ "undercut bank",
                             woody_debris == 0 & boulder == 0 & cobble == 0 & undercut_bank == 0 & aquatic_veg > 0 ~ "aquatic veg",
                             woody_debris == 0 & boulder == 0 & cobble == 0 & undercut_bank == 0 & aquatic_veg == 0 & overhanging_veg > 0 ~ "overhanging veg"),
         cover_2 = case_when(cover_1 != "boulder" & boulder > 0 ~ "boulder",
                             cover_1 != "cobble" & cobble > 0 ~ "cobble",
                             cover_1 != "undercut bank" & undercut_bank > 0 ~ "undercut bank",
                             cover_1 != "aquatic veg" & aquatic_veg > 0 ~ "aquatic veg",
                             cover_1 != "overhanging veg" & overhanging_veg > 0 ~ "overhanging veg"),
         cover_3 = case_when(cover_1 != "cobble" & cover_2 != "cobble" & cobble > 0 ~ "cobble",
                             cover_1 != "undercut bank" & cover_2 != "undercut bank" & undercut_bank > 0 ~ "undercut bank",
                             cover_1 != "aquatic veg" & cover_2 != "aquatic veg" & aquatic_veg > 0 ~ "aquatic veg",
                             cover_1 != "overhanging veg" & cover_2 != "overhanging veg" & overhanging_veg > 0 ~ "overhanging veg"),
         cover_4 = case_when(cover_1 != "undercut bank" & cover_2 != "undercut bank" & cover_3 != "undercut bank" & undercut_bank > 0 ~ "undercut bank",
                             cover_1 != "aquatic veg" & cover_2 != "aquatic veg" & cover_3 != "aquatic veg" & aquatic_veg > 0 ~ "aquatic veg",
                             cover_1 != "overhanging veg" & cover_2 != "overhanging veg" & cover_3 != "overhanging veg" & overhanging_veg > 0 ~ "overhanging veg"),
         cover_5 = case_when(cover_1 != "aquatic veg" & cover_2 != "aquatic veg" & cover_3 != "aquatic veg" & cover_4 != "aquatic veg" & aquatic_veg > 0 ~ "aquatic veg",
                             cover_1 != "overhanging veg" & cover_2 != "overhanging veg" & cover_3 != "overhanging veg" & cover_4 != "overhanging veg" & overhanging_veg > 0 ~ "overhanging veg"),
         cover_6 = case_when(cover_1 != "overhanging veg" & cover_2 != "overhanging veg" & cover_3 != "overhanging veg" & cover_4 != "overhanging veg" & cover_5 != "overhanging veg" & overhanging_veg > 0 ~ "overhanging veg")) |> 
  group_by(cover_1, cover_2, cover_3, cover_4, cover_5, cover_6) |> 
  summarize(count = sum(count))

cover_by_type |> 
  filter(!(is.na(cover_1) & is.na(cover_2)& is.na(cover_3)& is.na(cover_4)& is.na(cover_5)& is.na(cover_6))) |> 
  ggplot(aes(y = count,
             axis1 = cover_1, axis2 = cover_2, axis3 = cover_3)) +
  geom_alluvium(aes(fill = cover_1)) +
  geom_stratum(width = 1/12, fill = "black", color = "grey") +
  geom_label(stat = "stratum", aes(label = after_stat(stratum))) +
  scale_x_discrete(limits = c("cover_1", "cover_2","cover_3"))
```

# Absolute number of fish

```{r}
mini_snorkel_model_ready |> 
  mutate(inchannel_cover_dummy = factor(ifelse(percent_no_cover_inchannel <= 80 | percent_no_cover_overhead <= 80, 1, 0))) |> 
  group_by(inchannel_cover_dummy, fish_presence) |> 
  summarize(count = sum(count, na.rm = T)) |> 
  filter(fish_presence != 0) |> 
  mutate(category = ifelse(inchannel_cover_dummy == 0, "no cover", "cover")) |> 
  ggplot(aes(x = category, y = count)) +
  geom_col() +
  theme_bw() +
  labs(x = "",
       y = "total number of fish observed")
```
