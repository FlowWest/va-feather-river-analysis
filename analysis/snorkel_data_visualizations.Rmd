---
title: "Snorkel Data Visualizations"
author: "Ashley Vizek (FlowWest)"
date: "`r Sys.Date()`"
output: 
  html_document
---

Draft visualizations to communicate the Feather River snorkel data, specifically
as it is related to the Science Plan/Strategic Plan. 

It is difficult to tease apart correlations with fish observations and cover
when looking at each of the cover variables independently. When considering both
inchannel and overhead cover (and all types of each) together, then it becomes
apparent that more fish observations are made in areas with cover.

Analysis framing

- presence/absence
- absolute number of fish
- summarized by transect, summarized by location
- individual cover types
- cover or no cover


```{r, include = F}
library(tidyverse)
library(ggalluvial)
source(here::here("data-raw","pull_from_edi.R"))
mini_snorkel_model_ready <- mini_fish_raw |> 
  left_join(mini_locations_raw |> 
              distinct(location_table_id, date, channel_location)) |> 
  mutate(count = ifelse(is.na(count), 0, count),
        fish_presence = ifelse(count < 1, 0, 1),
         woody_debris = ifelse(percent_small_woody_cover_inchannel >= 20 | percent_large_woody_cover_inchannel >= 20, 1, 0),
         boulder = ifelse(percent_boulder_substrate >= 20, 1, 0),
         cobble = ifelse(percent_cobble_substrate >= 20, 1, 0),
         undercut_bank = ifelse(percent_undercut_bank >= 20, 1, 0),
         aquatic_veg = ifelse(percent_submerged_aquatic_veg_inchannel >= 20, 1, 0),
         overhanging_veg = ifelse(percent_no_cover_overhead <= 80, 1, 0))

colors_small <-  c("#9A8822", "#F5CDB4", "#F8AFA8", "#FDDDA0", "#74A089", #Royal 2
                   "#899DA4", "#C93312", "#DC863B" # royal 1 (- 3)
)
colors_full <-  c("#9A8822", "#F5CDB4", "#F8AFA8", "#FDDDA0", "#74A089", #Royal 2
                  "#899DA4", "#C93312", "#DC863B", # royal 1 (- 3)
                  "#F1BB7B", "#FD6467", "#5B1A18", "#D67236",# Grand Budapest 1 (-4)
                  "#D8B70A", "#02401B", "#A2A475", # Cavalcanti 1
                  "#E6A0C4", "#C6CDF7", "#D8A499", "#7294D4", #Grand Budapest 2
                  "#9986A5", "#EAD3BF", "#AA9486", "#B6854D", "#798E87", # Isle of dogs 2 altered slightly
                  "#F3DF6C", "#CEAB07", "#D5D5D3", "#24281A", # Moonriese 1, 
                  "#798E87", "#C27D38", "#CCC591", "#29211F", # moonrise 2
                  "#85D4E3", "#F4B5BD", "#9C964A", "#CDC08C", "#FAD77B" # moonrise 3 
)

microhabitat_plots <- mini_snorkel_model_ready |> 
  select(micro_hab_data_tbl_id, date, count, fish_presence, woody_debris, boulder, cobble, undercut_bank, aquatic_veg, overhanging_veg) |> group_by(micro_hab_data_tbl_id, date, woody_debris, boulder, cobble, undercut_bank, aquatic_veg, overhanging_veg) |> 
  summarize(count = sum(count, na.rm = T),
            fish_presence = sum(fish_presence),
            fish_presence = ifelse(fish_presence > 0, 1, 0))
```

# Cover/no cover {.tabset}

High level summary of the number of fish observed in habitats with cover (any cover type with greater than 20%) and no cover

- categorize habitat as cover or no cover
- group by cover/no cover and add up the number of fish observed

## Presence/absence by microhabitat plot

```{r, echo = F, message = F, warning=FALSE}
mini_snorkel_model_ready |> 
  mutate(inchannel_cover_dummy = factor(ifelse(percent_no_cover_inchannel <= 80 | percent_no_cover_overhead <= 80, 1, 0))) |> 
  select(micro_hab_data_tbl_id, date, count, fish_presence, woody_debris, boulder, cobble, undercut_bank, aquatic_veg, overhanging_veg, inchannel_cover_dummy) |> group_by(micro_hab_data_tbl_id, date, woody_debris, boulder, cobble, undercut_bank, aquatic_veg, overhanging_veg, inchannel_cover_dummy) |> 
  summarize(count = sum(count, na.rm = T),
            fish_presence = sum(fish_presence),
            fish_presence = ifelse(fish_presence > 0, 1, 0)) |> 
  mutate(category = ifelse(inchannel_cover_dummy == 0, "no cover", "cover"),
         fish_presence = ifelse(fish_presence == 0, "fish absent", "fish present")) |> 
  group_by(category, fish_presence) |> 
  tally() |> 
  ggplot(aes(x = as.factor(fish_presence), y = n, fill = category)) +
  scale_fill_manual(values = colors_small) + 
  geom_bar(stat= "identity", position = "dodge") +
  geom_text(aes(label = n), position = position_dodge(0.9)) +
  theme_bw() +
  #theme(legend.position = "none") +
  labs(x = "",
       y = "number of microhabitat plots")
```

## Count of fish observed

```{r, echo = F, message = F, warning=FALSE}
mini_snorkel_model_ready |> 
  mutate(inchannel_cover_dummy = factor(ifelse(percent_no_cover_inchannel <= 80 | percent_no_cover_overhead <= 80, 1, 0))) |> 
  #select(micro_hab_data_tbl_id, inchannel_cover_dummy, fish_presence) |> 
  #distinct() |> 
  group_by(inchannel_cover_dummy) |> 
  summarize(count = sum(count)) |> 
  #mutate(percent = (n/1235)*100) |> 
  mutate(category = ifelse(inchannel_cover_dummy == 0, "no cover", "cover")) |> 
  ggplot(aes(x = category, y = count, fill = category)) +
  scale_fill_manual(values = colors_small) + 
  geom_col() +
  theme_bw() +
  theme(legend.position = "none") +
  labs(x = "",
       y = "number of fish observed")
```

# Cover types {.tabset}

Same plots cover/no cover but categorizes cover similar to how presented in Strategic Plan

- Woody debris: small or large woody inchannel cover greater or equal to 20%
- Boulder: boulder substrate greater or equal to 20%
- Cobble: cobble substrate greater or equal to 20%
- Undercut bank: undercut bank greater or equal to 20%
- Overhanging vegetation: no cover overhead is less than or equal to 80%

Note that cover categories are not mutually exclusive, e.g fish observations for woody debris may also have undercut bank.

## Presence/absence by microhabitat plot

```{r, echo = F, message = F, warning=FALSE}
mini_snorkel_model_ready |> 
  mutate(inchannel_cover_dummy = factor(ifelse(percent_no_cover_inchannel <= 80 | percent_no_cover_overhead <= 80, 1, 0)),
         no_cover = ifelse(woody_debris == 0 & boulder == 0 & undercut_bank == 0 & aquatic_veg == 0 & overhanging_veg == 0, 1, 0)) |> 
  select(micro_hab_data_tbl_id, date, count, fish_presence, no_cover, woody_debris, boulder, cobble, undercut_bank, aquatic_veg, overhanging_veg, inchannel_cover_dummy) |> group_by(micro_hab_data_tbl_id, date, no_cover, woody_debris, boulder, cobble, undercut_bank, aquatic_veg, overhanging_veg, inchannel_cover_dummy) |> 
  summarize(count = sum(count, na.rm = T),
            fish_presence = sum(fish_presence),
            fish_presence = ifelse(fish_presence > 0, 1, 0)) |> 
  mutate(fish_presence = ifelse(fish_presence == 0, "fish absent", "fish present")) |> 
  pivot_longer(cols = c(no_cover, woody_debris, boulder, cobble, undercut_bank, aquatic_veg, overhanging_veg), names_to = "cover_type", values_to = "cover_exists") |> 
  filter(cover_exists == 1) |> 
  group_by(cover_type, fish_presence) |> 
  tally() |> 
  ggplot(aes(x = cover_type, y = n, fill = fish_presence)) +
  scale_fill_manual(values = c("#F5CDB4", "#9A8822")) + 
  geom_bar(stat= "identity", position = "dodge") +
  geom_text(aes(label = n), position = position_dodge(0.9)) +
  theme_bw() +
  theme(legend.position = "bottom",
        axis.text.x = element_text(angle = 30)) +
  labs(x = "",
       y = "number of microhabitat plots",
        fill = "")
```
## Count of fish observed

```{r, echo = F, message = F, warning=FALSE}
mini_snorkel_model_ready |> 
  mutate(inchannel_cover_dummy = factor(ifelse(percent_no_cover_inchannel <= 80 | percent_no_cover_overhead <= 80, 1, 0)),
         no_cover = ifelse(woody_debris == 0 & boulder == 0 & undercut_bank == 0 & aquatic_veg == 0 & overhanging_veg == 0, 1, 0)) |> 
  pivot_longer(cols = c(no_cover, woody_debris, boulder, cobble, undercut_bank, aquatic_veg, overhanging_veg), names_to = "cover_type", values_to = "cover_exists") |> 
  filter(cover_exists == 1) |> 
  group_by(cover_type) |> 
  summarize(count = sum(count)) |> 
  ggplot(aes(x = cover_type, y = count, fill = cover_type)) +
  scale_fill_manual(values = c("#9A8822","#9A8822","#9A8822","#F5CDB4","#9A8822","#9A8822","#9A8822")) + 
  geom_col() +
  theme_bw() +
  theme(legend.position = "none") +
  labs(x = "",
       y = "number of fish observed")
```

# Other plots

Understanding the overlap between cover categories

```{r, echo = F, message = F, warning=FALSE}
cover_by_type <- mini_snorkel_model_ready |> 
  select(count, woody_debris, boulder, cobble, undercut_bank, aquatic_veg, overhanging_veg) |> 
  mutate(cover_1 = case_when(woody_debris > 0 ~ "woody debris",
                             woody_debris == 0 & boulder > 0 ~ "boulder",
                             woody_debris == 0 & boulder == 0 & cobble > 0 ~ "cobble",
                             woody_debris == 0 & boulder == 0 & cobble == 0 & undercut_bank > 0 ~ "undercut bank",
                             woody_debris == 0 & boulder == 0 & cobble == 0 & undercut_bank == 0 & aquatic_veg > 0 ~ "aquatic veg",
                             woody_debris == 0 & boulder == 0 & cobble == 0 & undercut_bank == 0 & aquatic_veg == 0 & overhanging_veg > 0 ~ "overhanging veg"),
         cover_2 = case_when(cover_1 != "boulder" & boulder > 0 ~ "boulder",
                             cover_1 != "cobble" & cobble > 0 ~ "cobble",
                             cover_1 != "undercut bank" & undercut_bank > 0 ~ "undercut bank",
                             cover_1 != "aquatic veg" & aquatic_veg > 0 ~ "aquatic veg",
                             cover_1 != "overhanging veg" & overhanging_veg > 0 ~ "overhanging veg"),
         cover_3 = case_when(cover_1 != "cobble" & cover_2 != "cobble" & cobble > 0 ~ "cobble",
                             cover_1 != "undercut bank" & cover_2 != "undercut bank" & undercut_bank > 0 ~ "undercut bank",
                             cover_1 != "aquatic veg" & cover_2 != "aquatic veg" & aquatic_veg > 0 ~ "aquatic veg",
                             cover_1 != "overhanging veg" & cover_2 != "overhanging veg" & overhanging_veg > 0 ~ "overhanging veg"),
         cover_4 = case_when(cover_1 != "undercut bank" & cover_2 != "undercut bank" & cover_3 != "undercut bank" & undercut_bank > 0 ~ "undercut bank",
                             cover_1 != "aquatic veg" & cover_2 != "aquatic veg" & cover_3 != "aquatic veg" & aquatic_veg > 0 ~ "aquatic veg",
                             cover_1 != "overhanging veg" & cover_2 != "overhanging veg" & cover_3 != "overhanging veg" & overhanging_veg > 0 ~ "overhanging veg"),
         cover_5 = case_when(cover_1 != "aquatic veg" & cover_2 != "aquatic veg" & cover_3 != "aquatic veg" & cover_4 != "aquatic veg" & aquatic_veg > 0 ~ "aquatic veg",
                             cover_1 != "overhanging veg" & cover_2 != "overhanging veg" & cover_3 != "overhanging veg" & cover_4 != "overhanging veg" & overhanging_veg > 0 ~ "overhanging veg"),
         cover_6 = case_when(cover_1 != "overhanging veg" & cover_2 != "overhanging veg" & cover_3 != "overhanging veg" & cover_4 != "overhanging veg" & cover_5 != "overhanging veg" & overhanging_veg > 0 ~ "overhanging veg")) |> 
  group_by(cover_1, cover_2, cover_3, cover_4, cover_5, cover_6) |> 
  summarize(count = sum(count))

cover_by_type |> 
  filter(!(is.na(cover_1) & is.na(cover_2)& is.na(cover_3)& is.na(cover_4)& is.na(cover_5)& is.na(cover_6))) |> 
  ggplot(aes(y = count,
             axis1 = cover_1, axis2 = cover_2, axis3 = cover_3)) +
  geom_alluvium(aes(fill = cover_1)) +
  geom_stratum(width = 1/12, fill = "black", color = "grey") +
  geom_label(stat = "stratum", aes(label = after_stat(stratum))) +
  scale_x_discrete(limits = c("cover_1", "cover_2","cover_3")) +
  scale_fill_manual(values = colors_small) +
  theme_bw() +
  labs(y = "number of fish observations",
       fill = "")
```